<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>布商宝代理器</title>
    <script src="./public/js/flexible.js"></script>
    <link rel="stylesheet" href="./public/css/bootstrap.min.css">
    <link rel="stylesheet" href="./public/css/index.css">
</head>

<body>
    <div class="body-box">
        <div class="tool-bar">
            <div class="select-data">
                <div class="form-group">
                    <label for="disabledSelect">选择串口</label>
                    <select id="disabledSelect" class="form-control com">
                    </select>
                </div>
                <div class="form-group">
                    <label for="BaudRate">波特率</label>
                    <!-- <input type="text" class="form-control" id="BaudRate" value="9600"> -->
                    <select id="baudSelect" class="form-control baud">
                    </select>
                </div>
            </div>
            <!-- <div class="submit-data">
                <button class="btn btn-primary btn-block btn-submit">确定</button>
            </div> -->
        </div>
        <div class="content-box">
            <div class="receive-box">
                <div class="send-header">
                    <label>接受信息</label>
                </div>
                <div class="receive-windows">
                </div>
            </div>

            <div class="send-box">
                <!-- <div class="send-header">
                    <label>发送信息</label>
                </div>
                <div class="send-windows">
                    <textarea class="input-send-data"></textarea>
                </div> -->
                <div class="send-btn">
                    <div class="btn-box">
                        <div class="btn btn-warning btn-send">读取卡号</div>&nbsp&nbsp&nbsp
                        <div class="btn btn-danger btn-reset">清空信息</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    window.$ = window.jQuery = require('./public/js/jquery.min.js');
    let serialport = require('serialport');
    const Delimiter = require('@serialport/parser-delimiter');
    const InterByteTimeout = require('@serialport/parser-inter-byte-timeout')
    const util = require('./public/js/util.js')

    // const express = require('express')
    // // 开启服务
    // const app = express()
    // app.get('/',function (req, res) {
    //     res.json('hello world');
    // })

    const http  = require('http')
    const server = http.createServer((req,res) => {
        console.log('res',res)
        res.setHeader("Access-Control-Allow-Origin", "*")
        res.setHeader("Access-Control-Allow-Headers", "Content-Type")
        res.setHeader("content-type", "application/json")
        createPort().then(rfids => {
            res.end(rfids.join('|'));
        })
    })
    server.listen(9527);


    let port = null;
    let parser = null;

    serialport.list((err, ports) => {
        for (let item of ports) {
            $('.com').append(`<option>${item.comName}</option>`)
        }
    });
    const baudRates = [115200,4800,9600,19200]
    baudRates.forEach(item => {
        $('.baud').append(`<option>${item}</option>`)
    })


    function createPort(){
        
        const promise = new Promise(function(resolve,reject){
            if(port){
                port.close()
                port = null
            }
            let COM = $('#disabledSelect option:selected').text();
            let BaudRate = $('#baudSelect option:selected').text();
            console.log('端口和波特率',COM,BaudRate);
            port = new serialport(COM, {
                baudRate: parseInt(BaudRate)
            });

            parser = port.pipe(new InterByteTimeout({interval:5}))
        
            parser.on('data',(data) => {
                const rfids = util.intToHex(data)
                $('.receive-windows').append(rfids.join(',') + '</br>');
                port.close();
                port = null;
                resolve(rfids)
            })

            port.on('open', function() {
                $('.receive-windows').text(`打开串口: ${COM}, 波特率: ${BaudRate}`);
                $('.receive-windows').append('<br/>=======================================<br/>');
            })

            // 如果发生错误
            port.on('error', err => {
                $('.receive-windows').append(err.toString());
                reject(err);
            });
            sendDataPort()
        })
        return promise 
    }

    function sendDataPort(){
        var sendData = $('.input-send-data').val();
        if (port != {} && port != null) {
            const buf = new Buffer([0xBB,0x00,0x22,0x00,0x00,0x22,0x7E])
            port.write(buf, function(err){
                if (err) {
                    return console.log('Error on write: ', err.message)
                }
                console.log('message written',err)
            });
        }
    }

    // 开启端口
    $('.btn-submit').click((data) => {
        createPort()
    });

    // 点击发送信息
    $('.btn-send').click(() => {
        createPort().then(rfids => {
            console.log('rfids',rfids)
        })
    })

    // 清空信息
    $('.btn-reset').click(() => {
        $('.receive-windows').text('');
    })

</script>

</html>